name: CBS Automation Test (Headed Mode)

on:
  workflow_dispatch:

# Permissions for GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping queued runs
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - uses: actions/checkout@v4

      # Install Dependencies
      - name: Install Required Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb wget unzip curl

      # Set up Xvfb (Virtual Display for GUI Mode)
      - name: Start Xvfb
        run: Xvfb :99 -screen 0 1920x1080x24 &

      # Set up Maven
      - name: Set up Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: 3.9.9
      
      # Set up JDK 22
      - name: Set up JDK 22
        uses: actions/setup-java@v4
        with:
          java-version: '22'
          distribution: 'oracle'

      # Install Chrome (Ensure Correct Browser Version)
      - name: Install Chrome
        run: |
          sudo apt-get install -y google-chrome-stable
          google-chrome --version  # Verify installed version

      # Run Maven tests in **head mode** (without --headless)
      - name: Run Test (Headed Mode)
        run: |
          export DISPLAY=:99
          mvn test
        continue-on-error: true  # Prevent workflow failure if tests fail

      # Download and install Allure
      - name: Download and Install Allure
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.18.1/allure_2.18.1-1_all.deb
          sudo dpkg -i allure_2.18.1-1_all.deb

      # Generate Allure Report
      - name: Generate Allure Report
        run: |
          allure generate target/allure-results --clean -o build/allure-report

      # Upload Allure Report Artifacts
      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: build/allure-report
          retention-days: 15

      # Upload screenshots as Artifact
      - name: Upload Screenshots (if any)
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: ./src/main/resources/application.properties
          retention-days: 15

      # Set up GitHub Pages
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          name: gh-pages
          path: './build/allure-report'

     # Deploy Allure Report to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: gh-pages
